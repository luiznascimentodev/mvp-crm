generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// üè¢ TENANT (Multi-tenancy)
// ============================================================================

/// Representa uma empresa/organiza√ß√£o no sistema (SaaS Multi-tenant)
model Tenant {
  id String @id @default(uuid()) @db.Uuid

  // Identifica√ß√£o
  name String @db.VarChar(255)
  slug String @unique @db.VarChar(100)

  // Configura√ß√µes
  isActive Boolean @default(true)
  plan     String  @default("free") @db.VarChar(50)
  maxUsers Int     @default(5)
  maxLeads Int     @default(100)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Relacionamentos
  users      User[]
  leads      Lead[]
  contacts   Contact[]
  deals      Deal[]
  activities Activity[]

  @@map("tenants")
}

// ============================================================================
// üë§ USER (Usu√°rios do Sistema)
// ============================================================================

/// Usu√°rios que acessam o sistema (pertencentes a um Tenant)
model User {
  id String @id @default(uuid()) @db.Uuid

  // Relacionamento com Tenant
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Identifica√ß√£o
  email     String  @db.VarChar(255)
  name      String  @db.VarChar(255)
  avatarUrl String? @db.VarChar(500)

  // Autentica√ß√£o
  passwordHash String @db.VarChar(255)

  // Permiss√µes
  role     String  @default("member") @db.VarChar(50)
  isActive Boolean @default(true)

  // Auditoria
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Relacionamentos
  ownedLeads        Lead[]     @relation("LeadOwner")
  ownedContacts     Contact[]  @relation("ContactOwner")
  ownedDeals        Deal[]     @relation("DealOwner")
  createdActivities Activity[] @relation("ActivityCreator")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

// ============================================================================
// üéØ LEAD (Prospects)
// ============================================================================

/// Potenciais clientes (n√£o qualificados ainda)
model Lead {
  id String @id @default(uuid()) @db.Uuid

  // Relacionamento com Tenant
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Respons√°vel pelo Lead
  ownerId String? @db.Uuid
  owner   User?   @relation("LeadOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Informa√ß√µes B√°sicas
  name    String  @db.VarChar(255)
  email   String? @db.VarChar(255)
  phone   String? @db.VarChar(50)
  company String? @db.VarChar(255)

  // Qualifica√ß√£o
  source String? @db.VarChar(100) // "website", "referral", "cold_call", etc.
  status String  @default("new") @db.VarChar(50) // "new", "contacted", "qualified", "lost"

  // Dados Adicionais
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime  @updatedAt @db.Timestamptz
  deletedAt DateTime? @db.Timestamptz

  // Relacionamentos
  activities Activity[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([status])
  @@index([deletedAt])
  @@map("leads")
}

// ============================================================================
// üìá CONTACT (Contatos Qualificados)
// ============================================================================

/// Contatos qualificados (ex-Leads convertidos)
model Contact {
  id String @id @default(uuid()) @db.Uuid

  // Relacionamento com Tenant
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Respons√°vel pelo Contato
  ownerId String? @db.Uuid
  owner   User?   @relation("ContactOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Informa√ß√µes B√°sicas
  name    String @db.VarChar(255)
  email   String @db.VarChar(255)
  phone   String @db.VarChar(50)
  company String @db.VarChar(255)

  // Informa√ß√µes Adicionais
  position String? @db.VarChar(100)
  website  String? @db.VarChar(255)
  linkedin String? @db.VarChar(255)

  // Endere√ßo
  address String? @db.VarChar(255)
  city    String? @db.VarChar(100)
  state   String? @db.VarChar(50)
  zipCode String? @db.VarChar(20)
  country String? @db.VarChar(100)

  // Dados Adicionais
  notes String? @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime  @updatedAt @db.Timestamptz
  deletedAt DateTime? @db.Timestamptz

  // Relacionamentos
  deals      Deal[]
  activities Activity[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([ownerId])
  @@index([deletedAt])
  @@map("contacts")
}

// ============================================================================
// üí∞ DEAL (Oportunidades de Venda)
// ============================================================================

/// Negocia√ß√µes ativas com valor monet√°rio
model Deal {
  id String @id @default(uuid()) @db.Uuid

  // Relacionamento com Tenant
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Respons√°vel pelo Deal
  ownerId String? @db.Uuid
  owner   User?   @relation("DealOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Relacionamento com Contact
  contactId String  @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Restrict)

  // Informa√ß√µes B√°sicas
  title       String  @db.VarChar(255)
  description String? @db.Text

  // Financeiro
  value    Decimal @db.Decimal(15, 2) // Ex: 15000.50
  currency String  @default("BRL") @db.VarChar(3) // ISO 4217 (BRL, USD, EUR)

  // Pipeline
  stage             String    @db.VarChar(50) // "prospecting", "qualification", "proposal", "negotiation", "closed_won", "closed_lost"
  probability       Int       @default(0) // 0-100%
  expectedCloseDate DateTime? @db.Date

  // Status
  isActive   Boolean   @default(true)
  closedAt   DateTime? @db.Timestamptz
  lostReason String?   @db.Text

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime  @updatedAt @db.Timestamptz
  deletedAt DateTime? @db.Timestamptz

  // Relacionamentos
  activities Activity[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([contactId])
  @@index([stage])
  @@index([deletedAt])
  @@map("deals")
}

// ============================================================================
// üìã ACTIVITY (Atividades/Intera√ß√µes)
// ============================================================================

/// Registro de todas as intera√ß√µes (liga√ß√µes, emails, reuni√µes, tarefas)
model Activity {
  id String @id @default(uuid()) @db.Uuid

  // Relacionamento com Tenant
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Criador da Atividade
  createdById String @db.Uuid
  createdBy   User   @relation("ActivityCreator", fields: [createdById], references: [id], onDelete: Restrict)

  // Tipo de Atividade
  type String @db.VarChar(50) // "call", "email", "meeting", "task", "note"

  // Relacionamentos Polim√≥rficos (uma atividade pode estar em Lead, Contact ou Deal)
  leadId String? @db.Uuid
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  contactId String?  @db.Uuid
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  dealId String? @db.Uuid
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Conte√∫do
  subject     String  @db.VarChar(255)
  description String? @db.Text

  // Agendamento (para tarefas/reuni√µes)
  scheduledAt DateTime? @db.Timestamptz
  completedAt DateTime? @db.Timestamptz
  isCompleted Boolean   @default(false)

  // Dura√ß√£o (em minutos, para liga√ß√µes/reuni√µes)
  durationMinutes Int? @db.Integer

  // Auditoria
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime  @updatedAt @db.Timestamptz
  deletedAt DateTime? @db.Timestamptz

  @@index([tenantId])
  @@index([createdById])
  @@index([leadId])
  @@index([contactId])
  @@index([dealId])
  @@index([type])
  @@index([scheduledAt])
  @@index([deletedAt])
  @@map("activities")
}
